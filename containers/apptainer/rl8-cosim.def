Bootstrap: docker
From: rockylinux:8

%labels
    Author Ehab Shoubaki
    Version 1.0
    Description Rocky Linux 8 Apptainer Image

%environment
    export PATH=/usr/local/bin:/usr/bin:/bin
    export PATH=/usr/local/gridlabd/bin:$PATH
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8
    export OMPI_ALLOW_RUN_AS_ROOT=1
    export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    export PETSC_DIR=/usr/local/petsc-3.16.4
    export LD_LIBRARY_PATH=/usr/local/petsc-3.16.4/lib

%post
    echo "Installing basic packages..."
    dnf -y update --exclude=tzdata --exclude=glibc-langpack-en
    dnf -y install dnf-plugins-core
    dnf groupinstall -y 'Development Tools'
    dnf -y install epel-release
    dnf config-manager --set-enabled powertools
    dnf -y install \
        cmake \
        gcc gcc-c++ \
        git \
        make \
        wget \
        curl \
        swig \
        zeromq-devel \
        boost-devel \
        xerces-c-devel \
        hdf5-devel \
        ncurses-devel \
        ncurses-compat-libs \
        pkgconf-pkg-config \
	openssl-devel \
	bzip2-devel \
	libffi-devel \
	zlib-devel 

    # Install Python 3.10
    mkdir -p /build_python
    cd /build_python
    wget https://www.python.org/ftp/python/3.10.14/Python-3.10.14.tgz
    tar -xzf Python-3.10.14.tgz
    cd Python-3.10.14
    chmod -R +x configure
    
    ./configure --enable-optimizations --prefix=/usr/local/python3.10
    make -j10
    make install

    ln -s /usr/local/python3.10/bin/python3.10 /usr/local/bin/python3
    ln -s /usr/local/python3.10/bin/pip3.10 /usr/local/bin/pip3

    # Set up virtual environment
    python3 -m venv /opt/myenv
    source /opt/myenv/bin/activate
    pip install --upgrade pip
    pip install helics "helics[cli]" matplotlib \
                pypower pyrlu \
                scipy numpy==1.26.4   

    # Download, build and install HELICS
    mkdir -p ~/develop && cd ~/develop
    git clone --recurse-submodules https://github.com/GMLC-TDC/HELICS.git helics
    cd helics
    cmake -DCMAKE_INSTALL_PREFIX=/usr/local/helics \
          -DCMAKE_BUILD_TYPE=Release \
          -DHELICS_BUILD_CXX_SHARED_LIB=ON \
          -B build
    cmake --build build -j -t install

    # Install GridLab-D
    cd ~/develop
    git clone https://github.com/gridlab-d/gridlab-d.git gridlabd
    cd gridlabd
    git submodule update --init --recursive

    sed -i '/add_subdirectory(third_party\/jsoncpp_lib)/d' CMakeLists.txt
    sed -i '/get_target_property(jsoncpp_lib/d' CMakeLists.txt
    sed -i '/target_link_libraries(jsoncpp_lib/d' CMakeLists.txt

    cmake -DCMAKE_INSTALL_PREFIX=/usr/local/gridlabd \
          -DGLD_USE_HELICS=ON \
          -DGLD_HELICS_DIR=/usr/local \
          -B build
    cd build
    make -j8 && make install

    # Build Boost 1.78
    cd ~/develop
    wget https://archives.boost.io/release/1.78.0/source/boost_1_78_0.tar.gz
    tar -xvf boost_1_78_0.tar.gz
    cd boost_1_78_0
    ./bootstrap.sh --prefix=/usr/local/boost-1.78.0 --with-libraries=mpi,serialization,random,filesystem,system
    echo "using mpi ;" >> project-config.jam
    ./b2 -a -d+2 link=static stage
    ./b2 -a -d+2 link=static install

    # GA 5.8
    cd ~/develop
    wget https://github.com/GlobalArrays/ga/releases/download/v5.8/ga-5.8.tar.gz
    tar -xvf ga-5.8.tar.gz
    cd ga-5.8
    ./configure --with-mpi-ts --disable-f77 --without-blas --enable-cxx --enable-i4 \
        --prefix=/usr/local/ga-5.8
    make -j 10 install

    # PETSc 3.16.4
    cd ~/develop
    git clone https://gitlab.com/petsc/petsc.git
    cd petsc
    git checkout v3.16.4
    export PETSC_DIR=/root/develop/petsc
    ./configure --download-superlu_dist \
                --download-metis \
                --download-parmetis \
                --download-suitesparse \
                --download-f2cblaslapack \
                --prefix=/usr/local/petsc-3.16.4
    make && make install

    export PETSC_DIR=/usr/local/petsc-3.16.4
    export LD_LIBRARY_PATH=/usr/local/petsc-3.16.4/lib

    # GridPACK
    cd ~/develop
    git clone https://github.com/GridOPTICS/GridPACK.git
    cd GridPACK
    git submodule update --init
    cd src
    git checkout develop
    mkdir build && cd build

    cmake -D GA_DIR="/usr/local/ga-5.8" \
          -D BOOST_ROOT="/usr/local/boost-1.78.0" \
          -D Boost_DIR="/usr/local/boost-1.78.0/lib/cmake/Boost-1.78.0" \
          -D BOOST_LIBRARYDIR="/usr/local/boost-1.78.0/lib" \
          -D PETSC_DIR="/usr/local/petsc-3.16.4" \
          -D MPI_CXX_COMPILER='mpicxx' \
          -D MPI_C_COMPILER='mpicc' \
          -D MPIEXEC='mpiexec' \
          -D GRIDPACK_TEST_TIMEOUT=30 \
          -D CMAKE_INSTALL_PREFIX="/usr/local/GridPACK" \
          -D HELICS_INSTALL_DIR='/usr/local/helics' \
          -D CMAKE_BUILD_TYPE=Debug ..
    make -j 10 install

    echo "Cleaning up..."
    dnf clean all
    rm -rf /var/cache/dnf ~/develop/

%runscript
    echo "Welcome to the Co-simulation Toolchain"
    source /opt/myenv/bin/activate
    exec /bin/bash

