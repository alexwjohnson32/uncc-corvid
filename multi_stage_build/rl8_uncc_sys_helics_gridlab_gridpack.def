Bootstrap: localimage
From: rl8_uncc_sys_helics_gridlab.sif

%environment
    export PATH=/usr/local/gridlabd/bin:/usr/local/bin:/usr/bin:/bin
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8
    export OMPI_ALLOW_RUN_AS_ROOT=1
    export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    export PETSC_DIR=/usr/local/petsc-3.16.4
    export LD_LIBRARY_PATH=/usr/local/petsc-3.16.4/lib:$LD_LIBRARY_PATH
    export PATH=/opt/rh/gcc-toolset-11/root/usr/bin:$PATH
    export CPATH=/opt/rh/gcc-toolset-11/root/usr/include:$CPATH
    export LIBRARY_PATH=/opt/rh/gcc-toolset-11/root/usr/lib64:$LIBRARY_PATH
    export CPLUS_INCLUDE_PATH=/opt/rh/gcc-toolset-11/root/usr/include:$CPLUS_INCLUDE_PATH
    export PATH=/opt/myenv/bin/:/usr/lib64/openmpi/bin:$PATH
    export LD_LIBRARY_PATH=/usr/lib64/openmpi/lib:$LD_LIBRARY_PATH
    export CC=/opt/rh/gcc-toolset-11/root/usr/bin/gcc
    export CXX=/opt/rh/gcc-toolset-11/root/usr/bin/g++
    export LD_LIBRARY_PATH=/opt/rh/gcc-toolset-11/root/usr/lib64:$LD_LIBRARY_PATH
    export BOOST_ROOT=/usr/local/boost-1.78.0

%post
    # GridPACK dependency: GA-5.8
    cd ~/develop

    wget https://github.com/GlobalArrays/ga/releases/download/v5.8/ga-5.8.tar.gz
    tar -xvf ga-5.8.tar.gz
    cd ga-5.8

    ./configure --with-mpi-ts --disable-f77 --without-blas --enable-cxx --enable-i4 \
        --prefix=/usr/local/ga-5.8

    make -j 12 install

    # GridPACK dependency: PETSc-3.16.4
    cd ~/develop

    git clone https://gitlab.com/petsc/petsc.git
    cd petsc
    git checkout -b v3.16.4 tags/v3.16.4

    export PETSC_DIR=/root/develop/petsc
    wget http://ftp.mcs.anl.gov/pub/petsc/externalpackages/f2cblaslapack-3.4.2.q4.tar.gz
    ./configure --download-superlu_dist \
				--download-metis \
				--download-parmetis \
				--download-suitesparse \
				--download-f2cblaslapack=./f2cblaslapack-3.4.2.q4.tar.gz \
				--prefix=/usr/local/petsc-3.16.4

    make && make install

    export OMPI_ALLOW_RUN_AS_ROOT=1
    export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1

    export PETSC_DIR=/usr/local/petsc-3.16.4
    export LD_LIBRARY_PATH=/usr/local/petsc-3.16.4/lib

    # Now for GridPACK
    cd ~/develop

    git clone https://github.com/GridOPTICS/GridPACK.git
    cd GridPACK
    git checkout -b local_develop 03c716fbaeff037290a5a06cc54b205ec9965800
    git submodule update --init

    cd src
    mkdir build
    cd build

    cmake -D GA_DIR:STRING="/usr/local/ga-5.8" \
		  -D BOOST_ROOT:STRING="/usr/local/boost-1.78.0" \
		  -D Boost_DIR:STRING="/usr/local/boost-1.78.0/lib/cmake/Boost-1.78.0" \
		  -D BOOST_LIBRARYDIR:STRING="/usr/local/boost-1.78.0/lib"\
		  -D PETSC_DIR:STRING="/usr/local/petsc-3.16.4" \
		  -D MPI_CXX_COMPILER:STRING='mpicxx' \
		  -D MPI_C_COMPILER:STRING='mpicc' \
		  -D MPIEXEC:STRING='mpiexec' \
		  -D GRIDPACK_TEST_TIMEOUT:STRING=30 \
		  -D CMAKE_INSTALL_PREFIX:PATH="/usr/local/GridPACK" \
		  -D HELICS_INSTALL_DIR:STRING='/usr/local/helics' \
		  -D CMAKE_BUILD_TYPE:STRING=Debug ..

    make -j 12 install
    cd ~

    # Clean up
    dnf clean all

%labels
    Author Alex Johnson
    Version 1.0
    Description Rocky Linux 8 Base Image

%runscript
    echo "Welcome to your Rocky Linux 8 container"
    exec /bin/bash
